name: CI

on: [push, pull_request]

env:
  BUILD_TYPE: Debug
  CC: clang
  CXX: clang++

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v2

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.8
      with:
        cmake-version: '3.19.7'

    - name: Setup Ninja
      uses: seanmiddleditch/gha-setup-ninja@master
      with:
        version: '1.10.2'

#    - name: Setup IWYU
#       uses: EmilGedda/include-what-you-use-action@v1
#       with:
#         compilation-database-path: '${{github.workspace}}/build'
#         output-format: 'iwyu'
#         no-error: 'false'

    - name: Cache LLVM and Clang
      id: cache-llvm
      uses: actions/cache@v2
      with:
        path: ${{runner.temp}}/llvm
        key: llvm-11.0

    - name: Install LLVM and Clang
      uses: KyleMayes/install-llvm-action@v1
      with:
        version: "11.0"
        directory: ${{runner.temp}}/llvm
        cached: ${{steps.cache-llvm.outputs.cache-hit}}

    - name: Run clang-format check
      shell: bash
      run: ${{github.workspace}}/scripts/check-source-format.sh

    - name: Install Dependencies
      run: sudo ${{github.workspace}}/scripts/install-dependencies.sh

    - name: Configure
      shell: bash
      run: |
        mkdir ${{github.workspace}}/build
        cmake -G Ninja -S ${{github.workspace}} -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=$BUILD_TYPE

    - name: Build
      shell: bash
      run: cmake --build ${{github.workspace}}/build --config $BUILD_TYPE

    - name: Test
      shell: bash
      working-directory: ${{github.workspace}}/build
      run: ctest -C $BUILD_TYPE
